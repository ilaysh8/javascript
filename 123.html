<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>flaficapy – קפיברה פלאפי!</title>
<style>
    body{margin:0;overflow:hidden;background:#000;touch-action:none;user-select:none;-webkit-user-select:none;font-family:Arial, sans-serif;}
    canvas{display:block;}
    #menu{
        position:absolute;top:0;left:0;width:100%;height:100%;
        background:rgba(0,0,0,0.85);color:white;
        display:flex;flex-direction:column;align-items:center;justify-content:center;gap:25px;
        z-index:10;
    }
    h1{font-size:60px;margin:0;color:#00ff9d;text-shadow:0 0 20px #0f0;}
    .btn{
        padding:18px 40px;font-size:36px;background:#00ff9d;color:black;
        border:none;border-radius:15px;cursor:pointer;min-width:320px;
        box-shadow:0 0 30px #0f0;transition:0.2s;
    }
    .btn:hover{transform:scale(1.1);box-shadow:0 0 50px #0f0;}
</style>
</head>
<body>

<div id="menu">
    <h1>פלאפי קאפי!</h1>
    <button class="btn" data-speed="1.4">איטי מאוד (למתחילים)</button>
    <button class="btn" data-speed="2.7">איטי</button>
    <button class="btn" data-speed="4.2">בינוני</button>
    <button class="btn" data-speed="6.0">מהיר</button>
    <button class="btn" data-speed="8.5">מהיר מאוד!!!</button>
</div>

<canvas id="c"></canvas>
<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const menu = document.getElementById('menu');
canvas.width = innerWidth;
canvas.height = innerHeight;

// ==== משתנים שייקבעו לפי בחירת השחקן ====
let pipeSpeed = 2.7;        // ברירת מחדל (ישונה אחרי בחירה)
const gravity = 0.40;
const jumpPower = 9.2;
const spawnEveryFrames = 148;

let birdY = canvas.height / 2;
let vy = 0;
let pipes = [];
let score = 0;
let gameOn = false;  // מתחיל כבוי עד שבוחרים רמה
let frameCount = 0;

const birdImg = new Image();
birdImg.src = "https://images.vexels.com/media/users/3/318414/isolated/preview/488949fc3555ba9f5c3d7a5b0130719a-capybara-carrying-chicks-on-its-back.png";

// ==== בחירת רמה ====
document.querySelectorAll('.btn').forEach(btn => {
    btn.addEventListener('click', () => {
        pipeSpeed = parseFloat(btn.dataset.speed);
        menu.style.display = 'none';
        gameOn = true;
        loop(); // מתחילים את המשחק!
    });
});

// קפיצה
function flap() {
    if (gameOn) vy = -jumpPower;
}
document.addEventListener("touchstart", e => {e.preventDefault(); flap();}, {passive:false});
document.addEventListener("mousedown", e => {e.preventDefault(); flap();});
document.addEventListener("keydown", e => {if(e.code==="Space"||e.code==="ArrowUp"){e.preventDefault();flap();}});

function createPipe() {
    const top = 100 + Math.random() * (canvas.height - 500);
    pipes.push({x: canvas.width, top: top, gap: 330, passed: false});
}

function drawBird() {
    ctx.save();
    ctx.translate(120, birdY);
    ctx.rotate(vy * 0.045);
    ctx.shadowBlur = 50;
    ctx.shadowColor = "#ff0";
    ctx.drawImage(birdImg, -60, -60, 120, 120);
    ctx.restore();
}

function drawPipes() {
    ctx.fillStyle = "#00ff9d";
    ctx.shadowColor = "#0f0";
    ctx.shadowBlur = 25;
    pipes.forEach(p => {
        ctx.fillRect(p.x, 0, 100, p.top);
        ctx.fillRect(p.x-15, p.top-70, 130, 80);
        const bottomHeight = canvas.height - p.top - p.gap;
        ctx.fillRect(p.x, p.top + p.gap, 100, bottomHeight);
        ctx.fillRect(p.x-15, p.top + p.gap -10, 130, 80);
    });
}

function update() {
    if (!gameOn) return;

    vy += gravity;
    birdY += vy;

    if (frameCount % spawnEveryFrames === 0) createPipe();
    frameCount++;

    for (let i = pipes.length-1; i >= 0; i--) {
        pipes[i].x -= pipeSpeed;

        if (!pipes[i].passed && pipes[i].x + 100 < 120) {
            pipes[i].passed = true;
            score++;
        }

        if (120 + 55 > pipes[i].x && 120 - 55 < pipes[i].x + 100) {
            if (birdY - 55 < pipes[i].top || birdY + 55 > pipes[i].top + pipes[i].gap) endGame();
        }

        if (pipes[i].x + 100 < 0) pipes.splice(i,1);
    }

    if (birdY > canvas.height + 100 || birdY < -150) endGame();
}

function drawBackground() {
    const cycle = (frameCount / 1800) % 1;
    let top = "#0f172a", bottom = "#1e293b";
    if (cycle < 0.25) { top = lerp("#0f172a","#60a5fa",cycle*4); bottom = lerp("#1e293b","#99f6e4",cycle*4); }
    else if (cycle < 0.5) { top = "#60a5fa"; bottom = "#99f6e4"; }
    else if (cycle < 0.75) { top = lerp("#60a5fa","#fb923c",(cycle-0.5)*4); bottom = lerp("#99f6e4","#fecaca",(cycle-0.5)*4); }
    else { top = lerp("#fb923c","#1e293b",(cycle-0.75)*4); bottom = lerp("#fecaca","#475569",(cycle-0.75)*4); }

    const grad = ctx.createLinearGradient(0,0,0,canvas.height);
    grad.addColorStop(0, top);
    grad.addColorStop(1, bottom);
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    const angle = cycle * Math.PI * 2;
    const x = canvas.width/2 + Math.cos(angle) * canvas.width * 0.7;
    const y = canvas.height/2 + Math.sin(angle) * canvas.height * 0.4;
    if (cycle < 0.75) {
        ctx.fillStyle = "#FFD700"; ctx.shadowColor = "#FFAA00"; ctx.shadowBlur = 120;
        ctx.beginPath(); ctx.arc(x,y,90,0,Math.PI*2); ctx.fill();
    } else {
        ctx.fillStyle = "#f0f8ff"; ctx.shadowColor = "#ffffff88"; ctx.shadowBlur = 100;
        ctx.beginPath(); ctx.arc(x,y,70,0,Math.PI*2); ctx.fill();
    }
}

function lerp(a,b,t){
    const ah=parseInt(a.slice(1),16), bh=parseInt(b.slice(1),16);
    const ar=(ah>>16)&255, ag=(ah>>8)&255, ab=ah&255;
    const br=(bh>>16)&255, bg=(bh>>8)&255, bb=bh&255;
    return "#"+((1<<24)+((ar+t*(br-ar))<<16)+((ag+t*(bg-ag))<<8)+(ab+t*(bb-ab))|0).toString(16).slice(1);
}

function loop() {
    if (!gameOn) return; // לא מצייר כלום עד שבוחרים רמה

    drawBackground();
    drawPipes();
    drawBird();

    ctx.fillStyle = "white";
    ctx.font = "bold 140px Arial";
    ctx.textAlign = "center";
    ctx.shadowBlur = 20;
    ctx.shadowColor = "black";
    ctx.fillText(score, canvas.width/2, 160);

    update();
    requestAnimationFrame(loop);
}

function endGame() {
    gameOn = false;
    setTimeout(()=>{
        alert(`נפלת! הניקוד שלך: ${score}\nיאללה, עוד סיבוב!`);
        location.reload();
    }, 100);
}

window.addEventListener("resize", ()=>{
    canvas.width = innerWidth;
    canvas.height = innerHeight;
    birdY = canvas.height / 2;
});

// המשחק לא מתחיל עד שבוחרים רמה!
</script>
</body>
</html>