<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>Space Game </title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html, body {margin:0; padding:0; width:100%; height:100%; overflow:hidden; font-family:Arial, sans-serif; background:black;}
canvas {display:block;}
#scoreBoard, #levelBoard {position:absolute; top:10px; color:white; font-size:20px; padding:4px 8px; background:rgba(0,0,0,0.3); border-radius:8px; z-index:1000;}
#scoreBoard{left:10px;} #levelBoard{right:10px;}
#buttons {position:absolute; top:50px; left:50%; transform:translateX(-50%); display:flex; gap:10px; z-index:1000;}
button{padding:8px 16px; font-size:16px; border:none; border-radius:10px; cursor:pointer; font-weight:bold;}
#startBtn{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); padding:20px 40px; font-size:32px; background:lime; border:none; border-radius:15px; cursor:pointer; z-index:2000;}
#musicBtn{position: fixed; top:10px; left:50%; transform:translateX(-50%); width:90px; height:40px; z-index:2000; background:lime; border:none; border-radius:8px; cursor:pointer; font-size:18px;}
#overlay{display:none; position:absolute; inset:0; background:rgba(0,0,0,0.85); color:white; z-index:1500; text-align:center; padding:20px;}
#overlay input{font-size:20px; width:80px; margin-top:10px;}
#overlay button{margin-top:20px; padding:10px 20px; font-size:18px; background:lime; border:none; border-radius:10px; cursor:pointer;}
#joystick{position: fixed; bottom:40px; left:40px; width:120px; height:120px; background: rgba(255,255,255,0.1); border:2px solid rgba(0,255,255,0.3); border-radius:50%; z-index:2000; touch-action:none; display:none;}
#stick{position:absolute; width:50px; height:50px; left:35px; top:35px; background: rgba(0,255,255,0.6); border-radius:50%;}
#fireBtn{position: fixed; bottom:50px; right:30px; width:70px; height:70px; border-radius:50%; background:red; color:white; font-size:28px; border:none; display:none; z-index:2000; cursor:pointer;}
#gameOver{display:none; position:absolute; inset:0; background:rgba(0,0,0,0.9); color:red; text-align:center; z-index:2000;}
#gameOverBox{width:400px; padding:40px; background:rgba(0,0,0,0.85); color:red; font-size:50px; text-align:center; border:5px solid yellow; border-radius:20px; box-shadow:0 0 20px red; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);}
#gameOverBox button{padding:15px 30px; font-size:24px; background:lime; border:none; border-radius:15px; cursor:pointer;}
@media(max-width:820px){#joystick,#fireBtn{display:block;}}
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<div id="scoreBoard">拽: 0</div>
<div id="levelBoard">专: 1</div>

<div id="buttons">
<button id="pauseBtn" style="background:orange;">PAUSE</button>
<button id="restartBtn" style="background:red;">RESTART</button>
<button id="levelBtn" style="background:violet;">专</button>
</div>

<button id="startBtn">PLAY</button>
<button id="musicBtn"> ON</button>

<div id="overlay">
<h1 id="overlayTitle">专 专 (1-100)</h1>
<input type="number" id="overlayInput" min="1" max="100" value="1">
<button id="overlayClose">住专 专 砖拽</button>
</div>

<div id="joystick"><div id="stick"></div></div>
<button id="fireBtn"></button>

<div id="gameOver">
<div id="gameOverBox">
GAME OVER
<br><br>
<button id="restartFromOver">RESTART</button>
</div>
</div>

<script>
// ===== Canvas =====
const canvas=document.getElementById("gameCanvas");
const ctx=canvas.getContext("2d");
canvas.width=window.innerWidth;
canvas.height=window.innerHeight;

// ===== Variables =====
let score=parseInt(localStorage.getItem('score'))||0;
let level=parseInt(localStorage.getItem('level'))||1;
let playerSpeed=parseInt(localStorage.getItem('playerSpeed'))||5;
let started=false, paused=false;
let player={x:canvas.width/2-30, y:canvas.height-100, width:60, height:60, emoji:'', speed:playerSpeed};
let bullets=[], enemies=[], explosions=[];
let shootDelay=500, lastShootTime=0, lastEnemySpawn=0;
let keys={}, stars=[]; for(let i=0;i<200;i++) stars.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:Math.random()*2+1,speed:Math.random()*0.2+0.05});

// ===== Music =====
const songs=[{url:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', bpm:90}];
let audio=new Audio(); audio.loop=true;
let musicOn=true;
document.getElementById('musicBtn').onclick=()=>{
  musicOn=!musicOn;
  if(musicOn){audio.play(); document.getElementById('musicBtn').innerText=' ON';}
  else{audio.pause(); document.getElementById('musicBtn').innerText=' OFF';}
};

// ===== Shooting =====
function shoot(){if(!paused && started){const now=Date.now();if(now-lastShootTime>shootDelay){bullets.push({x:player.x+player.width/2-5,y:player.y,width:10,height:20});lastShootTime=now;}}}

// ===== Meteor =====
function spawnMeteor(){
  let size = 50 + Math.random()*20;
  let speed = 2 + level/10;
  let trail=[];
  enemies.push({x:Math.random()*(canvas.width-size),y:-size,width:size,height:size,speed:speed,trail:trail});
}

// ===== Update =====
function update(){
  if(paused||!started) return;

  player.x+=moveX;
  if(keys["ArrowLeft"]&&player.x>0) player.x-=player.speed;
  if(keys["ArrowRight"]&&player.x<canvas.width-player.width) player.x+=player.speed;
  player.x=Math.max(0,Math.min(canvas.width-player.width,player.x));

  bullets.forEach(b=>b.y-=8);
  bullets=bullets.filter(b=>b.y>0);

  enemies.forEach(e=>{
    e.y+=e.speed;
    e.trail.push({x:e.x+e.width/2,y:e.y+e.height/2,life:30});
    e.trail=e.trail.filter(p=>--p.life>0);
  });
  enemies=enemies.filter(e=>e.y<canvas.height+50);

  bullets.forEach((b,bi)=>{
    enemies.forEach((e,ei)=>{
      if(b.x<e.x+e.width && b.x+b.width>e.x && b.y<e.y+e.height && b.y+b.height>e.y){
        explosions.push({x:e.x,y:e.y,r:10,maxR:40});
        enemies.splice(ei,1); bullets.splice(bi,1);
        increaseScore(3);
      }
    });
  });

  explosions.forEach(ex=>ex.r+=2);
  explosions=explosions.filter(ex=>ex.r<ex.maxR);

  stars.forEach(s=>{s.y+=s.speed;if(s.y>canvas.height)s.y=0;});

  let now=Date.now();
  let minPerSec=0.2,maxPerSec=5;
  let meteorsPerSec=minPerSec + (level-1)*(maxPerSec-minPerSec)/99;
  let spawnRate=1000/meteorsPerSec;
  if(now-lastEnemySpawn>spawnRate){spawnMeteor(); lastEnemySpawn=now;}

  updateScoreBoard();

  if(enemies.some(e=>e.y+e.height>=canvas.height)){
    paused=true;
    document.getElementById('gameOver').style.display='block';
    saveGame();
  }
}

// ===== Draw =====
function drawPlayer(){
  ctx.font="50px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText(player.emoji, player.x+player.width/2, player.y+player.height/2);
}
function drawMeteor(e){
  let grad=ctx.createRadialGradient(e.x+e.width/2,e.y+e.height/2,5,e.x+e.width/2,e.y+e.height/2,e.width/2);
  grad.addColorStop(0,'#ff5500'); grad.addColorStop(1,'#aa0000');
  ctx.fillStyle=grad;
  ctx.beginPath(); ctx.arc(e.x+e.width/2,e.y+e.height/2,e.width/2,0,Math.PI*2); ctx.fill();
  e.trail.forEach(p=>{
    ctx.fillStyle=`rgba(255,165,0,${p.life/30})`;
    ctx.beginPath(); ctx.arc(p.x,p.y,5*p.life/30,0,Math.PI*2); ctx.fill();
  });
}
function draw(){
  ctx.fillStyle='black'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='white'; stars.forEach(s=>{ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();});
  drawPlayer();
  ctx.fillStyle='red'; bullets.forEach(b=>ctx.fillRect(b.x,b.y,b.width,b.height));
  enemies.forEach(drawMeteor);
  ctx.fillStyle='orange'; explosions.forEach(ex=>{ctx.beginPath();ctx.arc(ex.x+25,ex.y+25,ex.r,0,Math.PI*2);ctx.fill();});
}

// ===== Loop =====
function gameLoop(){update();draw();requestAnimationFrame(gameLoop);}
gameLoop();

// ===== Score =====
function increaseScore(points){score+=points; saveGame(); updateScoreBoard();}
function updateScoreBoard(){document.getElementById('scoreBoard').innerText='拽: '+score; document.getElementById('levelBoard').innerText='专: '+level;}

// ===== Overlay =====
const overlay=document.getElementById('overlay');
const overlayInput=document.getElementById('overlayInput');
document.getElementById('startBtn').onclick=()=>{started=true; paused=false; document.getElementById('startBtn').style.display='none'; if(musicOn){audio.src=songs[0].url; audio.play();}};
document.getElementById('pauseBtn').onclick=()=>{paused=!paused; if(paused) audio.pause(); else if(musicOn) audio.play();};
document.getElementById('restartBtn').onclick=()=>{restartGame();};
document.getElementById('restartFromOver').onclick=()=>{document.getElementById('gameOver').style.display='none'; restartGame();};
document.getElementById('levelBtn').onclick=()=>{paused=true; audio.pause(); overlay.style.display='block'; overlayInput.value=level;};
document.getElementById('overlayClose').onclick=()=>{level=parseInt(overlayInput.value)||1; overlay.style.display='none'; paused=false; if(musicOn) audio.play(); saveGame();};

// ===== Joystick & Fire =====
const joystick=document.getElementById('joystick'); 
const stick=document.getElementById('stick'); 
let touchId=null, moveX=0;
joystick.addEventListener('touchstart',e=>{touchId=e.changedTouches[0].identifier;});
joystick.addEventListener('touchmove',e=>{for(const t of e.changedTouches){if(t.identifier===touchId){const rect=joystick.getBoundingClientRect();const x=t.clientX-rect.left-rect.width/2;const maxDist=rect.width/2-25;const clampedX=Math.max(-maxDist,Math.min(maxDist,x));stick.style.left=35+clampedX+'px'; moveX=(clampedX/maxDist)*player.speed;}}});
joystick.addEventListener('touchend',()=>{stick.style.left='35px'; moveX=0;});
document.getElementById('fireBtn').addEventListener('touchstart',shoot);
document.getElementById('fireBtn').addEventListener('click',shoot);

// ===== Keyboard =====
document.addEventListener("keydown",e=>{
  keys[e.code]=true;
  if(e.code==='Space') shoot();
});
document.addEventListener("keyup",e=>keys[e.code]=false);
function updatePlayerMovement(){if(!paused && started) player.x+=moveX;}
setInterval(updatePlayerMovement,16);

// ===== Save & Restart =====
function saveGame(){localStorage.setItem('score',score); localStorage.setItem('level',level); localStorage.setItem('playerSpeed',player.speed);}
function restartGame(){score=0; bullets=[]; enemies=[]; explosions=[]; player.x=canvas.width/2-30; player.y=canvas.height-100; paused=false; saveGame(); updateScoreBoard();}
</script>

</body>
</html>
